<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Neon Frontier: 1v1 & Coop</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; background: #080808; color: #00f2ff; font-family: 'Courier New', Courier, monospace; overflow: hidden; display: flex; flex-direction: column; align-items: center; }
        #menu { background: rgba(0,0,0,0.95); padding: 30px; border: 3px solid #00f2ff; position: absolute; top: 10%; z-index: 10; border-radius: 15px; text-align: center; box-shadow: 0 0 30px #00f2ff; }
        canvas { background: #000; border: 2px solid #333; cursor: crosshair; }
        input { padding: 12px; border: 1px solid #00f2ff; background: #222; color: #00f2ff; margin: 10px; font-size: 18px; text-align: center; width: 220px; outline: none; }
        button { padding: 12px 25px; background: #00f2ff; color: #000; border: none; font-weight: bold; cursor: pointer; font-size: 16px; margin: 5px; }
        button:hover { background: #ff0055; color: #fff; }
        .mode-btn { width: 120px; font-size: 14px; opacity: 0.6; }
        .mode-btn.selected { opacity: 1; border: 2px solid #fff; }
        
        .ui-panel { position: absolute; padding: 10px; background: rgba(0,0,0,0.7); border: 1px solid #00f2ff; border-radius: 5px; font-size: 12px; pointer-events: none; }
        #player-info { top: 10px; left: 10px; }
        #wave-info { top: 10px; right: 10px; text-align: right; display: none; }
        
        #chat-container { position: absolute; bottom: 80px; left: 10px; width: 280px; display: flex; flex-direction: column; pointer-events: auto; }
        #chat-window { height: 120px; overflow-y: auto; background: rgba(0,0,0,0.8); border: 1px solid #00f2ff; padding: 5px; margin-bottom: 5px; font-size: 12px; }
        #chat-input { width: 100%; box-sizing: border-box; font-size: 14px; text-align: left; padding: 5px; margin: 0; }

        #inventory { position: absolute; bottom: 10px; right: 10px; display: flex; pointer-events: auto; }
        .slot { width: 65px; height: 60px; border: 2px solid #333; margin: 5px; background: #1a1a1a; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 9px; }
        .slot.active { border-color: #00f2ff; box-shadow: 0 0 10px #00f2ff; color: #fff; }
    </style>
</head>
<body>

    <div id="menu">
        <h1>NEON FRONTIER</h1>
        <p>DEINE ID: <b id="my-id" style="color:#ff0055; font-size: 24px;">....</b></p>
        <input type="text" id="username" placeholder="Dein Name" value="Spieler" maxlength="10">
        <br>
        <button id="btn-1v1" class="mode-btn selected" onclick="setMode('1v1')">1v1</button>
        <button id="btn-coop" class="mode-btn" onclick="setMode('coop')">COOP</button>
        <br>
        <input type="text" id="remote-id" placeholder="ID vom Partner">
        <br>
        <button id="connect-btn">VERBINDEN & STARTEN</button>
        <p><small>ENTER: Chat | 1-4: Slots</small></p>
    </div>

    <div id="player-info" class="ui-panel">
        HP: <span id="ui-hp">100</span> | Modus: <span id="ui-mode">Kampf</span>
    </div>

    <div id="wave-info" class="ui-panel">
        WELLE: <span id="ui-wave">1</span><br>
        GEGNER: <span id="ui-enemies">0</span>
    </div>

    <div id="chat-container">
        <div id="chat-window"></div>
        <input type="text" id="chat-input" placeholder="Nachricht..." maxlength="50">
    </div>

    <div id="inventory">
        <div class="slot active" id="slot1"><b>1</b><span>Pistole</span></div>
        <div class="slot" id="slot2"><b>2</b><span>Shotgun</span></div>
        <div class="slot" id="slot3"><b>3</b><span>Messer</span></div>
        <div class="slot" id="slot4"><b>4</b><span>Bauen</span></div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const WEAPONS = {
            1: { name: 'pistol', dmg: 15, rate: 250 },
            2: { name: 'shotgun', dmg: 20, rate: 800 },
            3: { name: 'knife', dmg: 50, rate: 400, range: 65 },
            4: { name: 'wall', hp: 120 }
        };

        const shortId = Math.floor(1000 + Math.random() * 9000).toString();
        const peer = new Peer(shortId);
        let conn;

        let gameMode = '1v1';
        let me = { id: shortId, name: 'Ich', x: 200, y: 200, hp: 100, angle: 0, weapon: 1, buildMode: false };
        let rival = { id: '', name: 'Gegner', x: -1000, y: -1000, hp: 100, angle: 0, active: false };
        let walls = [], bullets = [], enemies = [], particles = [];
        let wave = 1, isHost = false, lastAction = 0;
        const keys = {};

        function setMode(m) {
            gameMode = m;
            document.getElementById('btn-1v1').className = m === '1v1' ? 'mode-btn selected' : 'mode-btn';
            document.getElementById('btn-coop').className = m === 'coop' ? 'mode-btn selected' : 'mode-btn';
        }

        peer.on('open', id => document.getElementById('my-id').innerText = id);
        peer.on('connection', c => { conn = c; isHost = true; setupConn(); });

        document.getElementById('connect-btn').onclick = () => {
            me.name = document.getElementById('username').value || "Spieler";
            const rId = document.getElementById('remote-id').value;
            if(rId) { conn = peer.connect(rId); isHost = false; setupConn(); }
        };

        function setupConn() {
            document.getElementById('menu').style.display = 'none';
            if(gameMode === 'coop') document.getElementById('wave-info').style.display = 'block';
            conn.on('open', () => {
                rival.active = true;
                conn.send({ type: 'init', name: me.name, mode: gameMode });
                requestAnimationFrame(gameLoop);
            });
            conn.on('data', data => {
                if(data.type === 'init') { rival.name = data.name; gameMode = data.mode; if(gameMode === 'coop') document.getElementById('wave-info').style.display = 'block'; }
                if(data.type === 'sync') { rival.x = data.x; rival.y = data.y; rival.angle = data.angle; rival.hp = data.hp; rival.weapon = data.weapon; }
                if(data.type === 'shot') bullets.push(data.b);
                if(data.type === 'build') walls.push(data.wall);
                if(data.type === 'hit') { if(data.id === me.id) me.hp -= data.dmg; }
                if(data.type === 'msg') addChat(data.sender, data.txt);
                if(data.type === 'wall_break') walls = walls.filter(w => !(w.x === data.x && w.y === data.y));
                if(data.type === 'sync_enemies') enemies = data.enemies;
                if(data.type === 'sync_wave') { wave = data.wave; }
            });
        }

        function addChat(sender, txt) {
            const div = document.createElement('div');
            div.innerHTML = `<span style="color:#ff0055">${sender}:</span> ${txt}`;
            const win = document.getElementById('chat-window');
            win.appendChild(div); win.scrollTop = win.scrollHeight;
        }

        const chatInp = document.getElementById('chat-input');
        window.onkeydown = e => {
            if(document.activeElement === chatInp) {
                if(e.key === 'Enter') {
                    const msg = chatInp.value.trim();
                    if(msg && conn) { addChat(me.name, msg); conn.send({ type: 'msg', sender: me.name, txt: msg }); chatInp.value = ''; }
                    chatInp.blur();
                } return;
            }
            keys[e.key.toLowerCase()] = true;
            if(['1','2','3','4'].includes(e.key)) { me.weapon = parseInt(e.key); me.buildMode = (me.weapon === 4); updateUI(); }
            if(e.key === 'Enter') chatInp.focus();
        };
        window.onkeyup = e => keys[e.key.toLowerCase()] = false;
        window.onmousemove = e => me.angle = Math.atan2(e.clientY - me.y, e.clientX - me.x);

        window.onmousedown = () => {
            if(document.activeElement === chatInp) return;
            const now = Date.now();
            const w = WEAPONS[me.weapon];
            if(now - lastAction < (w.rate || 0)) return;

            if(me.buildMode) {
                const wx = Math.floor((me.x + Math.cos(me.angle)*50)/40)*40;
                const wy = Math.floor((me.y + Math.sin(me.angle)*50)/40)*40;
                if(!walls.some(w => w.x === wx && w.y === wy)) {
                    const wall = { x: wx, y: wy, hp: w.hp };
                    walls.push(wall); if(conn) conn.send({ type: 'build', wall });
                }
            } else if(me.weapon === 3) { // Messer
                if(Math.hypot(me.x - rival.x, me.y - rival.y) < w.range && gameMode === '1v1') {
                    conn.send({ type: 'hit', id: rival.id, dmg: w.dmg });
                }
                enemies.forEach((en, i) => {
                    if(Math.hypot(me.x - en.x, me.y - en.y) < w.range) damageEnemy(i, w.dmg);
                });
            } else { // Pistole/Shotgun
                const b = { x: me.x, y: me.y, vx: Math.cos(me.angle)*12, vy: Math.sin(me.angle)*12, owner: me.id, dmg: w.dmg };
                bullets.push(b); if(conn) conn.send({ type: 'shot', b });
                if(me.weapon === 2) { 
                    [-0.15, 0.15].forEach(off => {
                        const s = { ...b, vx: Math.cos(me.angle+off)*12, vy: Math.sin(me.angle+off)*12 };
                        bullets.push(s); if(conn) conn.send({ type: 'shot', b: s });
                    });
                }
            }
            lastAction = now;
        };

        function damageEnemy(index, dmg) {
            enemies[index].hp -= dmg;
            if(enemies[index].hp <= 0) enemies.splice(index, 1);
        }

        function updateUI() {
            document.getElementById('ui-hp').innerText = Math.max(0, Math.floor(me.hp));
            document.getElementById('ui-mode').innerText = me.buildMode ? 'BAUEN' : 'KAMPF';
            document.getElementById('ui-wave').innerText = wave;
            document.getElementById('ui-enemies').innerText = enemies.length;
            for(let i=1; i<=4; i++) document.getElementById('slot'+i).className = (me.weapon === i) ? 'slot active' : 'slot';
        }

        function spawnWave() {
            if(!isHost || gameMode !== 'coop') return;
            for(let i=0; i < 3 + wave * 2; i++) {
                const side = Math.random() < 0.5;
                enemies.push({
                    x: side ? (Math.random() < 0.5 ? -50 : canvas.width + 50) : Math.random() * canvas.width,
                    y: !side ? (Math.random() < 0.5 ? -50 : canvas.height + 50) : Math.random() * canvas.height,
                    hp: 30 + wave * 15,
                    speed: 1.5 + Math.min(wave * 0.2, 3)
                });
            }
        }

        function gameLoop() {
            ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width, canvas.height);

            if(document.activeElement !== chatInp) {
                if(keys['w']) me.y -= 3.5; if(keys['s']) me.y += 3.5;
                if(keys['a']) me.x -= 3.5; if(keys['d']) me.x += 3.5;
            }
            if(conn) conn.send({ type: 'sync', x: me.x, y: me.y, angle: me.angle, hp: me.hp, weapon: me.weapon });

            // Coop Logik (Nur Host berechnet Gegner)
            if(gameMode === 'coop') {
                if(isHost) {
                    if(enemies.length === 0) { wave++; spawnWave(); conn.send({type: 'sync_wave', wave}); }
                    enemies.forEach(en => {
                        const target = Math.hypot(me.x - en.x, me.y - en.y) < Math.hypot(rival.x - en.x, rival.y - en.y) ? me : rival;
                        const ang = Math.atan2(target.y - en.y, target.x - en.x);
                        en.x += Math.cos(ang) * en.speed; en.y += Math.sin(ang) * en.speed;
                        if(Math.hypot(me.x - en.x, me.y - en.y) < 25) me.hp -= 0.2;
                    });
                    conn.send({ type: 'sync_enemies', enemies });
                }
                enemies.forEach(en => {
                    ctx.fillStyle = '#ff0000'; ctx.shadowBlur = 10; ctx.shadowColor = 'red';
                    ctx.beginPath(); ctx.arc(en.x, en.y, 12, 0, 7); ctx.fill();
                    ctx.shadowBlur = 0;
                });
            }

            walls.forEach(w => {
                ctx.strokeStyle = '#00f2ff'; ctx.strokeRect(w.x, w.y, 40, 40);
                ctx.fillStyle = `rgba(0, 242, 255, ${w.hp/120 * 0.2})`; ctx.fillRect(w.x, w.y, 40, 40);
            });

            bullets.forEach((b, i) => {
                b.x += b.vx; b.y += b.vy;
                ctx.fillStyle = b.owner === me.id ? '#0f0' : '#f00';
                ctx.beginPath(); ctx.arc(b.x, b.y, 3, 0, 7); ctx.fill();
                
                walls.forEach((w, wi) => {
                    if(b.x > w.x && b.x < w.x+40 && b.y > w.y && b.y < w.y+40) {
                        w.hp -= b.dmg; bullets.splice(i, 1);
                        if(w.hp <= 0) { if(conn) conn.send({type:'wall_break', x:w.x, y:w.y}); walls.splice(wi, 1); }
                    }
                });

                if(gameMode === '1v1' && b.owner === me.id && Math.hypot(rival.x - b.x, rival.y - b.y) < 20) {
                    conn.send({ type: 'hit', id: rival.id, dmg: b.dmg }); bullets.splice(i, 1);
                }

                if(isHost && gameMode === 'coop' && b.owner !== 'npc') {
                    enemies.forEach((en, ei) => {
                        if(Math.hypot(en.x - b.x, en.y - b.y) < 15) { damageEnemy(ei, b.dmg); bullets.splice(i, 1); }
                    });
                }
            });

            drawPlayer(me, '#00f2ff'); if(rival.active) drawPlayer(rival, '#ff0055');
            if(me.hp <= 0) { alert("Game Over!"); location.reload(); }
            updateUI(); requestAnimationFrame(gameLoop);
        }

        function drawPlayer(p, col) {
            ctx.save(); ctx.translate(p.x, p.y);
            ctx.fillStyle = '#222'; ctx.fillRect(-20, -35, 40, 4);
            ctx.fillStyle = col; ctx.fillRect(-20, -35, (p.hp/100)*40, 4);
            ctx.fillStyle = '#fff'; ctx.font = "10px Courier"; ctx.textAlign = "center"; ctx.fillText(p.name, 0, -42);
            ctx.rotate(p.angle); ctx.shadowBlur = 10; ctx.shadowColor = col;
            ctx.fillStyle = col; ctx.fillRect(-15, -15, 30, 30);
            ctx.fillStyle = '#fff'; ctx.fillRect(12, -2, 12, 4);
            ctx.restore();
        }

        if(isHost) spawnWave();
    </script>
</body>
</html>
