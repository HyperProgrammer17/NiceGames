<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ARENA BATTLE - LEGENDARY EDITION</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #050508;
            --accent: #00f2ff;
            --coin: #ffcc00;
            --panel: rgba(20, 20, 30, 0.95);
            --player-default: #34c759;
        }

        body {
            margin: 0; background: var(--bg); color: white;
            font-family: 'Inter', sans-serif; overflow: hidden;
            display: flex; flex-direction: column; height: 100vh;
        }

        .hud {
            position: absolute; top: 20px; left: 20px; pointer-events: none;
            display: flex; flex-direction: column; gap: 5px; z-index: 10;
        }

        .stat-box { background: rgba(0,0,0,0.5); padding: 10px 20px; border-radius: 8px; border-left: 4px solid var(--accent); }
        .label { font-size: 10px; color: #888; font-weight: 800; letter-spacing: 1px; }
        .value { font-family: 'Orbitron'; font-size: 20px; }

        #shop-toggle {
            position: absolute; bottom: 20px; left: 20px;
            background: var(--panel); border: 1px solid var(--accent); color: white;
            padding: 15px 25px; border-radius: 12px; font-family: 'Orbitron'; cursor: pointer;
            z-index: 20; transition: 0.3s;
        }

        #shop-menu {
            position: fixed; inset: 0; background: var(--panel);
            display: none; flex-direction: column; align-items: center; justify-content: flex-start;
            z-index: 100; padding: 20px; overflow-y: auto;
        }

        .shop-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;
            max-width: 900px; width: 100%; margin-top: 20px;
        }

        .shop-item {
            background: #1a1a25; border: 1px solid #333; padding: 15px;
            border-radius: 12px; text-align: center; transition: 0.2s;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .shop-item.active-skin { border-color: var(--accent); box-shadow: 0 0 15px var(--accent); }
        .shop-item:hover { border-color: var(--accent); }

        .item-preview { width: 40px; height: 40px; border-radius: 50%; margin: 0 auto 10px; border: 2px solid white; }

        .buy-btn {
            background: var(--accent); color: black; border: none; width: 100%;
            padding: 10px; border-radius: 5px; font-weight: 800; cursor: pointer; margin-top: 10px;
            font-family: 'Inter', sans-serif;
        }

        .buy-btn.equip-btn { background: #555; color: white; }
        .buy-btn.equip-btn.active { background: var(--player-default); }
        .buy-btn:disabled { background: #444; cursor: not-allowed; }

        canvas { display: block; background: #08080c; }

        .exit-btn {
            position: absolute; top: 20px; right: 20px;
            background: rgba(255,255,255,0.1); color: white; border: none;
            padding: 8px 15px; border-radius: 5px; text-decoration: none; font-size: 10px;
            font-family: 'Orbitron'; z-index: 10;
        }

        #game-over {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            z-index: 200; flex-direction: column; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

    <a href="#" class="exit-btn" onclick="location.reload()">RESTART</a>

    <div class="hud">
        <div class="stat-box">
            <div class="label">SCORE</div>
            <div id="score" class="value">0</div>
        </div>
        <div class="stat-box" style="border-color: var(--coin)">
            <div class="label">COINS</div>
            <div id="coins" class="value">0</div>
        </div>
        <div class="stat-box" style="border-color: #ff3b30">
            <div class="label">HP</div>
            <div id="hp" class="value">100 / 100</div>
        </div>
        <div id="cooldown-box" class="stat-box" style="border-color: #af52de; display: none;">
            <div class="label">ABILITY READY IN</div>
            <div id="cooldown-val" class="value">0.0s</div>
        </div>
    </div>

    <button id="shop-toggle" onclick="toggleShop()">SHOP / UPGRADES (P)</button>

    <div id="shop-menu">
        <h1 style="font-family: 'Orbitron'; color: var(--accent); margin-bottom: 10px;">NEON SHOP</h1>
        <div id="shop-coins" class="value" style="color: var(--coin); margin-bottom: 30px;">0 Coins</div>
        <div class="shop-grid" id="upgrades-grid"></div>
        <h2 style="font-family: 'Orbitron'; color: var(--accent); margin-top: 40px; margin-bottom: 20px;">LEGENDARY SKINS</h2>
        <div class="shop-grid" id="skins-grid"></div>
        <button class="buy-btn" style="max-width: 200px; margin-top: 50px; background: white; color: black;" onclick="toggleShop()">BACK TO ARENA</button>
    </div>

    <div id="game-over">
        <h1 style="font-family: 'Orbitron'; color: #ff3b30; font-size: 50px;">GAME OVER</h1>
        <p id="final-score" class="value">Score: 0</p>
        <button class="buy-btn" style="max-width: 200px;" onclick="location.reload()">TRY AGAIN</button>
    </div>

    <canvas id="arena"></canvas>

<script>
const canvas = document.getElementById('arena');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let gameState = {
    score: 0,
    coins: 100, // Kleines Startkapital
    active: true,
    paused: false,
    upgrades: { fire: 0, speed: 0, hp: 0 },
    skins: { 'default': true },
    activeSkin: 'default'
};

const player = {
    x: canvas.width / 2,
    y: canvas.height / 2,
    radius: 15,
    color: '#34c759',
    hp: 100,
    maxHp: 100,
    speed: 5,
    fireRate: 400,
    projectileSpeed: 10,
    specialCooldown: 0,
    lastShot: 0,
    isInvulnerable: false,
    speedBoost: 1,
    hasShield: false,
    isBuffed: false,
    hasTrail: false
};

let projectiles = [];
let enemies = [];
let particles = [];
let keys = {};
let mouse = { x: 0, y: 0, isDown: false };

const PLAYER_SKINS = {
    'default': {
        name: "Neon Guardian", color: '#34c759', price: 0,
        description: "Standard player. Reliable shots.",
        ability: (p) => {
            projectiles.push({
                x: p.x, y: p.y, velocity: { x: Math.cos(p.angle) * p.speed, y: Math.sin(p.angle) * p.speed },
                radius: 4, color: p.color, damage: 20
            });
        }
    },
    'pyro': {
        name: "Pyro Nova", color: '#ff6600', price: 200,
        description: "Exploding fireballs.",
        ability: (p) => {
            projectiles.push({
                x: p.x, y: p.y, velocity: { x: Math.cos(p.angle) * p.speed * 0.7, y: Math.sin(p.angle) * p.speed * 0.7 },
                radius: 8, color: '#ff6600', damage: 40, special: 'explode'
            });
        }
    },
    'phantom': {
        name: "Phantom", color: '#af52de', price: 400,
        description: "Piercing shots & Ghost Dash.",
        ability: (p) => {
            projectiles.push({
                x: p.x, y: p.y, velocity: { x: Math.cos(p.angle) * p.speed, y: Math.sin(p.angle) * p.speed },
                radius: 5, color: '#af52de', damage: 25, special: 'pierce', pierceCount: 3
            });
        },
        specialAction: () => {
            if(player.specialCooldown <= 0) {
                player.isInvulnerable = true; player.speedBoost = 2.5;
                setTimeout(() => { player.isInvulnerable = false; player.speedBoost = 1; }, 800);
                player.specialCooldown = 5000;
            }
        }
    }
};

// Event Listeners
window.addEventListener('keydown', e => {
    keys[e.key.toLowerCase()] = true;
    if(e.key.toLowerCase() === 'p') toggleShop();
});
window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
window.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; });
window.addEventListener('mousedown', e => { 
    if(e.button === 0) mouse.isDown = true;
    if(e.button === 2) useSpecialAbility();
});
window.addEventListener('mouseup', e => { if(e.button === 0) mouse.isDown = false; });
canvas.addEventListener('contextmenu', e => e.preventDefault());

function toggleShop() {
    gameState.paused = !gameState.paused;
    document.getElementById('shop-menu').style.display = gameState.paused ? 'flex' : 'none';
    if(gameState.paused) updateShopUI();
}

function updateShopUI() {
    document.getElementById('shop-coins').innerText = `${gameState.coins} Coins`;
    const upgradesGrid = document.getElementById('upgrades-grid');
    upgradesGrid.innerHTML = '';
    
    const upTypes = [
        {id:'fire', name:'FIRE RATE', cost:50},
        {id:'speed', name:'MOVE SPEED', cost:40},
        {id:'hp', name:'MAX HP', cost:60}
    ];

    upTypes.forEach(up => {
        const lvl = gameState.upgrades[up.id];
        const cost = up.cost * (lvl + 1);
        const item = document.createElement('div');
        item.className = 'shop-item';
        item.innerHTML = `
            <div class="label">${up.name}</div>
            <div class="value">Lvl ${lvl} / 5</div>
            <button class="buy-btn" onclick="buyUpgrade('${up.id}', ${cost})" ${(lvl>=5 || gameState.coins<cost)?'disabled':''}>
                ${lvl>=5?'MAX':cost+' Coins'}
            </button>`;
        upgradesGrid.appendChild(item);
    });

    const skinsGrid = document.getElementById('skins-grid');
    skinsGrid.innerHTML = '';
    for (const id in PLAYER_SKINS) {
        const s = PLAYER_SKINS[id];
        const item = document.createElement('div');
        item.className = `shop-item ${id === gameState.activeSkin ? 'active-skin' : ''}`;
        item.innerHTML = `
            <div class="item-preview" style="background:${s.color}"></div>
            <div class="value" style="color:${s.color}">${s.name}</div>
            <div class="label">${s.description}</div>
            ${gameState.skins[id] ? 
                `<button class="buy-btn equip-btn ${id===gameState.activeSkin?'active':''}" onclick="equipSkin('${id}')">${id===gameState.activeSkin?'EQUIPPED':'EQUIP'}</button>` :
                `<button class="buy-btn" onclick="buySkin('${id}', ${s.price})" ${gameState.coins<s.price?'disabled':''}>${s.price} Coins</button>`
            }`;
        skinsGrid.appendChild(item);
    }
}

function buyUpgrade(type, cost) {
    if(gameState.coins >= cost && gameState.upgrades[type] < 5) {
        gameState.coins -= cost;
        gameState.upgrades[type]++;
        if(type === 'fire') player.fireRate *= 0.8;
        if(type === 'speed') player.speed += 1;
        if(type === 'hp') { player.maxHp += 20; player.hp = player.maxHp; }
        updateShopUI(); updateHUD();
    }
}

function buySkin(id, price) {
    if(gameState.coins >= price) {
        gameState.coins -= price;
        gameState.skins[id] = true;
        equipSkin(id);
    }
}

function equipSkin(id) {
    gameState.activeSkin = id;
    player.color = PLAYER_SKINS[id].color;
    updateShopUI();
}

function useSpecialAbility() {
    const s = PLAYER_SKINS[gameState.activeSkin];
    if(s.specialAction) s.specialAction();
}

function spawnEnemy() {
    if(gameState.paused || !gameState.active) return;
    const radius = 12 + Math.random() * 15;
    let x, y;
    if (Math.random() < 0.5) {
        x = Math.random() < 0.5 ? -radius : canvas.width + radius;
        y = Math.random() * canvas.height;
    } else {
        x = Math.random() * canvas.width;
        y = Math.random() < 0.5 ? -radius : canvas.height + radius;
    }
    const speed = 1.5 + (gameState.score / 5000);
    enemies.push({ x, y, radius, color: '#ff3b30', hp: 40 + (gameState.score/100), maxHp: 40 + (gameState.score/100), speed });
    setTimeout(spawnEnemy, Math.max(500, 2000 - gameState.score / 100));
}

function createExplosion(x, y, color, count=10) {
    for(let i=0; i<count; i++) {
        particles.push({
            x, y, radius: Math.random()*3, color,
            velocity: { x: (Math.random()-0.5)*10, y: (Math.random()-0.5)*10 },
            alpha: 1
        });
    }
}

function updateHUD() {
    document.getElementById('score').innerText = Math.floor(gameState.score);
    document.getElementById('coins').innerText = gameState.coins;
    document.getElementById('hp').innerText = `${Math.max(0, Math.ceil(player.hp))} / ${player.maxHp}`;
    
    const cdBox = document.getElementById('cooldown-box');
    if(player.specialCooldown > 0) {
        cdBox.style.display = 'block';
        document.getElementById('cooldown-val').innerText = (player.specialCooldown/1000).toFixed(1) + "s";
    } else {
        cdBox.style.display = 'none';
    }
}

function update() {
    if(!gameState.active) return;
    if(gameState.paused) { requestAnimationFrame(update); return; }

    ctx.fillStyle = 'rgba(5, 5, 8, 0.2)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Player Cooldowns
    if(player.specialCooldown > 0) player.specialCooldown -= 16.6;

    // Player Movement
    const moveSpeed = player.speed * player.speedBoost;
    if(keys['w']) player.y -= moveSpeed;
    if(keys['s']) player.y += moveSpeed;
    if(keys['a']) player.x -= moveSpeed;
    if(keys['d']) player.x += moveSpeed;
    
    player.x = Math.max(player.radius, Math.min(canvas.width - player.radius, player.x));
    player.y = Math.max(player.radius, Math.min(canvas.height - player.radius, player.y));

    // Draw Player
    ctx.shadowBlur = 15; ctx.shadowColor = player.color;
    ctx.fillStyle = player.color;
    ctx.beginPath(); ctx.arc(player.x, player.y, player.radius, 0, Math.PI*2); ctx.fill();
    ctx.shadowBlur = 0;

    if(mouse.isDown) {
        const now = Date.now();
        if(now - player.lastShot > player.fireRate) {
            const angle = Math.atan2(mouse.y - player.y, mouse.x - player.x);
            PLAYER_SKINS[gameState.activeSkin].ability({ x: player.x, y: player.y, angle, speed: player.projectileSpeed, color: player.color });
            player.lastShot = now;
        }
    }

    // Projectiles
    projectiles.forEach((p, pi) => {
        p.x += p.velocity.x; p.y += p.velocity.y;
        ctx.fillStyle = p.color;
        ctx.beginPath(); ctx.arc(p.x, p.y, p.radius, 0, Math.PI*2); ctx.fill();

        if(p.x < 0 || p.x > canvas.width || p.y < 0 || p.y > canvas.height) {
            projectiles.splice(pi, 1);
        }
    });

    // Enemies
    enemies.forEach((e, ei) => {
        const angle = Math.atan2(player.y - e.y, player.x - e.x);
        e.x += Math.cos(angle) * e.speed;
        e.y += Math.sin(angle) * e.speed;

        // Draw Enemy
        ctx.fillStyle = e.color;
        ctx.beginPath(); ctx.arc(e.x, e.y, e.radius, 0, Math.PI*2); ctx.fill();
        
        // Health bar
        ctx.fillStyle = '#333'; ctx.fillRect(e.x-15, e.y-e.radius-10, 30, 4);
        ctx.fillStyle = '#ff3b30'; ctx.fillRect(e.x-15, e.y-e.radius-10, (e.hp/e.maxHp)*30, 4);

        // Collision Player-Enemy
        const dist = Math.hypot(player.x - e.x, player.y - e.y);
        if(dist < player.radius + e.radius && !player.isInvulnerable) {
            player.hp -= 0.5;
            updateHUD();
            if(player.hp <= 0) {
                gameState.active = false;
                document.getElementById('game-over').style.display = 'flex';
                document.getElementById('final-score').innerText = "Score: " + Math.floor(gameState.score);
            }
        }

        // Collision Projectile-Enemy
        projectiles.forEach((p, pi) => {
            const pDist = Math.hypot(p.x - e.x, p.y - e.y);
            if(pDist < p.radius + e.radius) {
                e.hp -= p.damage;
                if(p.special !== 'pierce') projectiles.splice(pi, 1);
                
                if(e.hp <= 0) {
                    createExplosion(e.x, e.y, e.color, 15);
                    gameState.score += 100;
                    gameState.coins += 5;
                    enemies.splice(ei, 1);
                    updateHUD();
                }
            }
        });
    });

    // Particles
    particles.forEach((p, i) => {
        p.x += p.velocity.x; p.y += p.velocity.y;
        p.alpha -= 0.02;
        ctx.globalAlpha = p.alpha;
        ctx.fillStyle = p.color;
        ctx.beginPath(); ctx.arc(p.x, p.y, p.radius, 0, Math.PI*2); ctx.fill();
        ctx.globalAlpha = 1;
        if(p.alpha <= 0) particles.splice(i, 1);
    });

    requestAnimationFrame(update);
}

// Start
spawnEnemy();
update();
updateHUD();
</script>
</body>
</html>